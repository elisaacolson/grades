---
title: "COLSON"
author: "Elisa Colson"
format: html
---

link to my GitHub : https://github.com/elisaacolson/grades

```{r}
here::i_am("grades.Rproj")
library(here)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(lubridate)
```

### Question 1

```{r}
cours <- read_csv(here("DATA/courses.csv"))
```

### Question 2

```{r}
cours %>% 
  arrange(course) %>% 
  rename(
    Course = course,
    `Course ID` = course_id,
    Trimester = trimester,
    `Number of Exams` = nb_grades
  ) %>% 
  kable() 
```

### Question 3

```{r}
student <- read_csv(here("DATA/students.csv"))

```

```{r}
spec(student)
```

```{r}
col_types = cols(
    id = col_integer(),
    group = col_factor(),
    birth_date = col_date(format = "%Y-%m-%d"),
    sex = col_factor()
  )

```

The `birth_date` column of the students data frame is of class `r class(student$birth_date)`.

### Question 4

```{r}
grades <- read_csv(here("DATA/grades.csv"))
grades <- read_delim(
  here("DATA/grades.csv"),
  delim = ";",        # Séparateur ;
  na = "*",           # NA représenté par *
  col_types = cols(
    id = col_integer(),
    course_id = col_integer(),
    grade = col_double()
  )
)

```

## Student population analysis

### Question 5

```{r}
student %>% 
  count(group) %>% 
  ggplot(aes(x = group, y = n)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Number of Students per Group",
    x = "Group",
    y = "Number of Students"
  )
```

### Question 6

```{r}
ggplot(student, aes(x = group, fill = sex)) +
  geom_bar() +
  labs(
    title = "Gender Balance per Group",
    x = "Group",
    y = "Number of Students",
    fill = "Gender"
  )
```

### Question 7

```{r}

student <- student %>% 
  mutate(
    age = round(time_length(today() - birth_date, unit = "year"))
  )

# histogram of age
ggplot(student, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  labs(
    title = "Distribution of Student Ages",
    x = "Age (years)",
    y = "Number of Students"
  ) +
  theme_minimal()
```

```{r}
colnames(student)

```

### Question 8

```{r}
# compute median age by group
median_age_by_group <- student %>% 
  mutate(age = round(time_length(today() - birth_date, unit = "year"))) %>% 
  group_by(group) %>% 
  summarise(median_age = as.integer(median(age))) %>% 
  rename(Group = group, `Median Age` = median_age)

median_age_by_group %>% 
  kable()
```

### Question 9

```{r}
# find the student the oldest by group
oldest_by_group <- student %>% 
  mutate(age = round(time_length(today() - birth_date, unit = "year"))) %>% 
  group_by(group) %>% 
  slice_max(age, n = 1) %>%  
  ungroup() %>% 
  select(id, sex, age, group) %>% 
  arrange(desc(age)) %>%  
  rename(ID = id, Sex = sex, Age = age, Group = group)


oldest_by_group %>% 
  kable()
```

## Simple grade analysis

### Question 10

```{r}
nb_grades <- grades %>% 
  filter(!is.na(grade)) %>% 
  nrow()
```

The data set contains `r nb_grades` grades.

### Question 11

```{r}
grades %>% 
  left_join(student, by = "id") %>% 
  left_join(cours, by = "course_id") %>% 
  filter(course == "Ayurveda and Traditional Medicine") %>% 
  group_by(group) %>% 
  summarise(avg_grade = mean(grade, na.rm = TRUE)) %>% 
  ggplot(aes(x = group, y = avg_grade)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Average Grade in Ayurveda and Traditional Medicine by Group",
    x = "Group",
    y = "Average Grade"
  ) +
  theme_minimal()
```

### Question 12

```{r}
grades %>% 
  left_join(cours, by = "course_id") %>% 
  filter(!is.na(grade)) %>%  # Enlève les notes manquantes
  ggplot(aes(x = as.factor(trimester), y = grade, fill = as.factor(trimester))) +
  geom_boxplot() +
  labs(
    title = "Distribution of Grades by Trimester",
    x = "Trimester",
    y = "Grade",
    fill = "Trimester"
  ) 
```

## Attendance Analysis

### Question 13

```{r}
# number of grades by student
nb_grades_per_student <-grades %>% 
  filter(!is.na(grade)) %>% 
  group_by(id) %>% 
  summarise(nb_grades = n()) %>% 
  left_join(student %>% select(id, group, sex), by = "id")
```

```{r}

nb_grades_per_student %>% 
  slice_sample(n = 10) %>% 
  kable()

# statistics
nb_grades_per_student %>% 
  summarise(
    Minimum = min(nb_grades),
    Maximum = max(nb_grades),
    Average = round(mean(nb_grades), 1),
    Median = median(nb_grades)
  ) %>% 
  kable()
```

### Question 14

```{r}
nb_grades_per_student %>% 
  ggplot(aes(x = sex, y = nb_grades, fill = sex)) +
  geom_violin(alpha = 0.7) +
  geom_boxplot(width = 0.2, alpha = 0.5) +
  scale_fill_manual(values = c("F" = "#E91E63", "M" = "#2196F3")) +
  labs(
    title = "Distribution of Number of Grades by Gender",
    x = "Gender",
    y = "Number of Grades"
  )
```

### Question 15

```{r}
# Create the dataframe
music_dance_grades <- grades %>% 
  left_join(cours, by = "course_id") %>% 
  filter(course == "Music and Dance") %>%  
  filter(!is.na(grade)) %>%  
  group_by(id) %>% 
  summarise(nb_grades_music_dance = n()) %>% 
  left_join(student %>% select(id, group), by = "id")


music_dance_grades %>% 
  slice_sample(n = 10) %>% 
  kable()
```

### Question 16

```{r}
# distribution of the number of grades
distribution_music_dance <- music_dance_grades %>% 
  count(nb_grades_music_dance, name = "nb_students")


distribution_music_dance %>% 
  kable()


distribution_music_dance %>% 
  ggplot(aes(x = nb_grades_music_dance, y = nb_students)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = nb_students), vjust = -0.5) +
  labs(
    title = "Distribution of Number of Grades in Music and Dance",
    x = "Number of Grades",
    y = "Number of Students"
  ) +
  theme_minimal()
```

### Question 17

```{r}
music_dance_grades %>% 
  ggplot(aes(x = factor(group), y = nb_grades_music_dance)) +
  geom_boxplot(fill = "lightblue") +
  labs(
    title = "Number of Grades in Music and Dance by Group",
    x = "Group",
    y = "Number of Grades"
  ) +
  theme_minimal()
```

### Question 18

```{r}
music_dance_grades <- grades %>% 
  left_join(cours, by = "course_id") %>% 
  filter(course == "Music and Dance") %>%  
  filter(!is.na(grade)) %>%  
  group_by(id) %>% 
  summarise(nb_grades_music_dance = n()) %>% 
  left_join(student %>% select(id, group, sex), by = "id")

ggplot(music_dance_grades, aes(x = factor(group), 
                               y = nb_grades_music_dance)) +
  geom_boxplot(fill = "lightblue") +
  facet_wrap(~ sex) +
  labs(
    title = "Number of Grades in Music & Dance by Group, Separated by Sex",
    x = "Group",
    y = "Number of Grades"
  ) +
  theme_minimal()
```

## Grade Analysis

### Question 19

```{r}
# mean by student and by group
grades_wide <- grades %>%
  filter(!is.na(grade)) %>%                     
  group_by(id, course_id) %>%                  
  summarise(avg_grade = mean(grade), .groups = "drop") %>%  
  left_join(cours %>% select(course_id, course), by = "course_id") %>%  
  left_join(student %>% select(id, group), by = "id") %>%  
  mutate(avg_grade = round(avg_grade, 2)) %>%  
  select(id, group, course, avg_grade) %>%
  pivot_wider(                                 
    names_from = course,
    values_from = avg_grade
  )


grades_wide %>%
  select(id, group, `Architecture and Sculpture`, `Astrology and Astrology`) %>%  # Sélectionner id, group et 2 cours pour l’extrait
  slice_sample(n = 5) %>%  
  kable()               
```

### Question 20

```{r}
grades_wide %>%
  ggplot(aes(
    x = `Martial Arts and Self-Defense`,
    y = `Music and Dance`
  )) +
  geom_jitter(width = 0.2, height = 0.2, color = "steelblue", alpha = 0.7, size = 3) +
  geom_smooth(method = "lm", color = "darkred", linetype = "dashed") +
  labs(
    title = "Average Grades: Music and Dance vs Martial Arts and Self-Defense",
    x = "Average Grade in Martial Arts and Self-Defense",
    y = "Average Grade in Music and Dance"
  ) +
  theme_minimal(base_size = 14) +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

The graph shows us that there is a slightly correlation between these two grade(red line). \### Question 21

```{r}
correlation_by_group <- grades_wide %>%
  select(group, `History and Civilization of India`, `Vedic Philosophy and Spirituality`) %>%
  group_by(group) %>%                              
  summarise(
    correlation = cor(
      `History and Civilization of India`,
      `Vedic Philosophy and Spirituality`,
      use = "complete.obs"  
    ),
    .groups = "drop"
  )


correlation_by_group %>% 
  kable()
```

We observ that for every groups (except 11) the correlation is negative between these two classes. Some groups more than others with -0.55 of correlation for the group 12 compared to the group 19 which has -0.05 of correlation. Maybe because they both ask for a lot of works \### Question 22

```{r}
# correlation by group
correlation_by_group <- grades_wide %>%
  select(group, `History and Civilization of India`, `Vedic Philosophy and Spirituality`) %>%
  group_by(group) %>%
  summarise(
    correlation = cor(
      `History and Civilization of India`,
      `Vedic Philosophy and Spirituality`,
      use = "complete.obs"
    ),
    .groups = "drop"
  )

# select the group with the higher correlation
target_group <- correlation_by_group %>%
  slice_max(abs(correlation), n = 1) %>%
  pull(group)

# student of this group
students_target_group <- grades_wide %>%
  filter(group == target_group)

#scatter plot
ggplot(students_target_group, aes(
  x = `Vedic Philosophy and Spirituality`,
  y = `History and Civilization of India`
)) +
  geom_point(color = "steelblue", size = 3, alpha = 0.7) + 
  geom_smooth(method = "lm", color = "darkred", linetype = "dashed", se = FALSE) + 
  labs(
    title = paste0("Group ", target_group, ": History vs Vedic Philosophy"),
    x = "Average Grade in Vedic Philosophy and Spirituality",
    y = "Average Grade in History and Civilization of India"
  ) 
```

There is a clear correlation between these two variables, as we selected the extreme values. This confirms that they are strongly negatively correlated. \### Question 23

```{r}
# compute the final grade
final_grades <- grades_wide %>%
  rowwise() %>%  
  mutate(final_grade = mean(c_across(-c(id, group)), na.rm = TRUE)) %>%  
  ungroup() %>%
  left_join(student %>% select(id, sex), by = "id") %>%  # add the variable sex
  select(id, group, sex, final_grade) %>%  # keep only the columns we want
  arrange(desc(final_grade))  


final_grades %>%
  slice_head(n = 5) %>%
  kable()
```

The group 9 has the 4 first of the prom. We can assume that this group is better than the others. \### Question 24

```{r}
ggplot(final_grades, aes(x = factor(group), y = final_grade)) +
  geom_boxplot(fill = "lightblue") +
  geom_jitter(width = 0.2, alpha = 0.6, color = "steelblue") + 
  labs(
    title = "Final Grades by Group",
    x = "Group",
    y = "Final Grade"
  ) +
  theme_minimal(base_size = 14)

```

Initially, I chose to analyze the data using a table showing the mean, median, and standard deviation. However, I believe that this graph illustrates the differences between the groups much more clearly. Indeed, as in the previous question, we can see that Group 9, for instance, stands out significantly compared to the others.

### Question 25

```{r}
ggplot(final_grades, aes(x = factor(group), y = final_grade, fill = sex)) +
  geom_boxplot(width = 0.6, position = position_dodge(0.9)) + 
  geom_jitter(aes(color = sex), size = 2, alpha = 0.5, 
              position = position_jitterdodge(jitter.width = 0.25, dodge.width = 0.9)) +
  labs(
    title = "Final Grades by Group and Sex",
    x = "Group",
    y = "Final Grade",
    fill = "Sex",
    color = "Sex"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  
    legend.position = "top"
  )
```

We cannot observe a clear difference between males and females. However, if we look more closely, for instance in Group 19, the girls have, on average, higher grades, although the top students in the class are male.

### Question 26

```{r}
grades_long <- grades_wide %>% #using grades_wide because it already has the mean of each student.
  pivot_longer(
    cols = -c(id, group), 
    names_to = "course", 
    values_to = "avg_grade"
  ) %>%
  left_join(cours %>% select(course, trimester), by = "course")

# compute for each student:
pass_df <- grades_long %>%
  group_by(id, group) %>%
  summarise(
    final_grade = mean(avg_grade, na.rm = TRUE),
    min_course = min(avg_grade, na.rm = TRUE),
    trimester1 = mean(avg_grade[trimester == 1], na.rm = TRUE),
    trimester2 = mean(avg_grade[trimester == 2], na.rm = TRUE),
    trimester3 = mean(avg_grade[trimester == 3], na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    pass = (min_course >= 5) & (trimester1 >= 10) & (trimester2 >= 10) & (trimester3 >= 10)
  ) %>%
  select(id, group, final_grade, pass) %>%
  arrange(desc(final_grade))

pass_df %>% slice_head(n = 5) %>% kable()
```

### Question 27

```{r}
fail_high_grade <- pass_df %>%
  filter(pass == FALSE & final_grade >= 10)

n_students <- nrow(fail_high_grade)
n_students

fail_high_grade %>% slice_sample(n=5) %>%kable()
```

### Question 28

```{r}
# calculate pass rate per group
pass_rate_group <- pass_df %>%
  group_by(group) %>%
  summarise(
    pass_rate = mean(pass) * 100,  # percentage of students who passed
    n_students = n(),
    .groups = "drop"
  ) %>%
  arrange(desc(pass_rate))

# display the table
pass_rate_group %>% kable()

# plot pass rate per group
ggplot(pass_rate_group, aes(x = factor(group), y = pass_rate)) +
  geom_col(fill = "steelblue", width = 0.6) +  # reduce width to separate bars
  geom_text(aes(label = paste0(round(pass_rate,1),"%")), vjust = -0.5, size = 4) +
  labs(title = "pass rate per group", x = "group", y = "pass rate (%)") +
  theme_minimal(base_size = 14)

```

### Question 29

```{r}
# calculate average grade per student and course
grades_avg <- grades %>%
  filter(!is.na(grade)) %>%
  group_by(id, course_id) %>%
  summarise(avg_grade = mean(grade), .groups = "drop") %>%
  left_join(cours %>% select(course_id, course), by = "course_id")

# count number of students failing per course (avg < 5)
course_fail_count <- grades_avg %>%
  filter(avg_grade < 5) %>%
  group_by(course) %>%
  summarise(n_failures = n(), .groups = "drop") %>%
  arrange(desc(n_failures))

```

the course that contributes the most to student failure is `r course_fail_count$course[1]`, with `r course_fail_count$n_failures[1]` students failing because of it.

### Question 30

```{r}
# combine age with pass_df
pass_age <- pass_df %>%
  left_join(student %>% select(id, age), by = "id")

# calculate pass rate per age
pass_rate_age <- pass_age %>%
  group_by(age) %>%
  summarise(pass_rate = mean(pass) * 100, n_students = n(), .groups = "drop")

# display table (optional)
pass_rate_age %>% kable()

# plot pass rate as a function of age
ggplot(pass_rate_age, aes(x = age, y = pass_rate)) +
  geom_line(color = "steelblue", size = 1.2) +
  geom_point(color = "darkred", size = 2) +
  labs(
    title = "pass rate as a function of student age",
    x = "age",
    y = "pass rate (%)"
  ) +
  theme_minimal(base_size = 14)
```

